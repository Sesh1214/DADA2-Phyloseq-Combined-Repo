library(phyloseq)
library(vegan)
library(ggplot2)
library(ape)
seqtab_absolute_noblanks <- read.csv("seqtab_noblanks.csv", header = TRUE, row.names = 1)
seqtab_relative_noblanks <- decostand(seqtab_absolute_noblanks, method='total', MARGIN = 1)
View(seqtab_relative)
taxa_df <- read.csv("taxa.csv", header = TRUE, sep = ",", row.names = 1)
taxa_matrix <- as.matrix(taxa_df)
metadata_noblanks <- read.csv("Metadata_May2022_noblanks.csv", header = TRUE, row.names = 1)

#Preparing and Creating the Phyloseq Object
otu_tab <- otu_table(seqtab_relative_noblanks, taxa_are_rows = FALSE)
sample_dat <- sample_data(metadata_noblanks)
tax_dat <- tax_table(taxa_matrix)
ps <- merge_phyloseq(otu_tab, sample_dat, tax_dat)
rank_names(ps)

#Genus Level Phyloseq Object
ps_genus <- tax_glom(ps, "Genus")
p1 <- plot_bar(ps_genus, fill = "Genus")
ggsave(filename = 'ps_genus.pdf', plot=p1, width=30, height=8)

#Family level Phyloseq Object
ps_family <- tax_glom(ps, "Family")
p2 <- plot_bar(ps_family, fill = "Family")
ggsave(filename = 'ps_family.pdf', plot=p2, width=30, height=8)


#Making This Interactive with Plotly and Viewing it on the local browser. This does it for the entire phyloseq object
ps_updated <- tax_fix(ps) %>% phyloseq_validate()
ord_explore(ps_updated)

#Create a Phyloseq Object to Compare the following
#Create One with Only Cluster 1 and compare metastatic to non-metastatic samples within the cluster
#Create One for Clusters 2 and 3 separately and compare them.
#Create one for clusters 2 and 3 together and compare them.
seqtab_relative_13 <- read.csv("seqtab_relative_Cluster1_Cluster3.csv", header = TRUE, row.names = 1)
taxa_df <- read.csv("taxa.csv", header = TRUE, sep = ",", row.names = 1)
taxa_matrix <- as.matrix(taxa_df)
metadata_13 <- read.csv("Metadata_NonMetsClusters.csv", header = TRUE, row.names = 1)

#Heatmap
genus_heatmap <- plot_heatmap(ps, "PCoA", "manhattan", taxa.label = "Genus", taxa.order = "Genus", low = "#66CCFF", high = "#000033", na.value = "white")
ggsave(filename = "genus_heatmap.pdf", plot = genus_heatmap, width = 30, height = 8)
family_heatmap <- plot_heatmap(ps, "PCoA", "manhattan", taxa.label = "Family", taxa.order = "Family", low = "#66CCFF", high = "#000033", na.value = "white")
ggsave(filename = "family_heatmap.pdf", plot = genus_heatmap, width = 30, height = 8)

#Plot Ordination
ps.ord <- ordinate(ps, "PCoA", "manhattan")
p1 <- plot_ordination(ps, ps.ord, type = "taxa", color = "Genus", title = "Genus Ordination Plot")
ggsave(filename = "Genus_PCOA.pdf", plot = p1, width = 30, height = 8)
p2 <- plot_ordination(ps, ps.ord, type = "taxa", color = "Family", title = "Family Ordination Plot")
ggsave(filename = "Family_PCOA.pdf", plot = p2, width = 30, height = 8)
p3 <- plot_ordination(ps, ps.ord, type = "samples", label = "sample_id", color = "metastasis", title = "Metastatic Samples")
ggsave(filename = "Metastatic Samples.pdf", plot = p3, width = 30, height = 8)
p4 <- plot_ordination(ps, ps.ord, type = "samples", label = "sample_id", color = "subcategory_at_initial_urine_collection", title = "Subcategory at Initial Urine Collection")
ggsave(filename = "Subcategory at Initial Urine Collection.pdf", plot = p4, width = 30, height = 8)

#PCOA Plot After Extracting Co-Ordinates
class(seqtab_relative_noblanks)
seqtab_matrix <- as.matrix(seqtab_relative_noblanks)
dist_matrix_genus <- dist(seqtab_matrix, method = "manhattan")
pcoa_genus <- pcoa(dist_matrix_genus, correction = "none", rn = NULL)
biplot_genus <- biplot(pcoa_genus, plot.axes = c(1,2), dir.axis1=1, dir.axis2=1, rn = NULL, main = NULL)
biplot_genus
ggsave(filename = "PCOA Plot of Samples Without Blanks.pdf", plot = biplot_genus, width = 30, height = 8)

#Extract the Axis co-ordinates and do K-Means on them
pcoa_genus$vectors
pcoa_coords <- as.data.frame(pcoa_genus$vectors)
head(pcoa_coords)
pcoa_coords_final1 <- as.data.frame(pcoa_coords$Axis.1)
pcoa_coords_final2 <- as.data.frame(pcoa_coords$Axis.2)
pcoa_coords_genus_final <- cbind(pcoa_coords_final1, pcoa_coords_final2)
kmeans_genus <- kmeans(pcoa_coords_genus_final, 3, nstart = 20)
kmeans_genus
kmeans_plot <- plot(pcoa_coords_genus_final, col = (kmeans_genus$cluster + 1), main = "K-Means Clustering of Samples - May 2022", xlab = "", ylab = "", pch = 20, cex = 2)
ggsave(filename = "KMeansClustering.pdf", plot = kmeans_plot, width = 30, height = 8)
kmeans_clusterdata <- kmeans_genus$cluster
sample_list <- cbind(kmeans_clusterdata, pcoa_coords_genus_final)
head(sample_list)
rownames(seqtab_absolute_noblanks)
rownames(sample_list) <- rownames(seqtab_absolute_noblanks)
head(sample_list)
sample_cluster_list <- cbind(sample_list, metadata_noblanks)
write.csv(file = "Sample_Cluster_List.csv", sample_cluster_list)
ggplot(sample_cluster_list, aes(x=pcoa_coords$Axis.1, y=pcoa_coords$Axis.2, color = metastasis)) + geom_point(alpha = 0.5, size = 1) + geom_text(aes(label = rownames(sample_list)))

#Network analysis
ps_network <- plot_net(ps, type = "taxa", distance = "manhattan", point_alpha = 1, point_label = "Genus", rescale = TRUE, point_size = 2)
ggsave(filename = "Phyloseq_Network.pdf", plot = ps_network, width = 40, height = 30)
ps_network_build <- ggplot_build(ps_network)
head(ps_network_build$data[[3]])
ps_network_data <- ps_network_build$data[[3]]
ps_network_coords <- data.frame(ps_network_data$label, ps_network_data$x, ps_network_data$y)
head(ps_network_coords)
ggplot(ps_network_coords, aes(x=ps_network_data.x, y = ps_network_data.y))+ geom_point()
ps_network_coords_matrix <- as.matrix(ps_network_coords)
ps_network_coords_matrix[is.na(ps_network_coords_matrix)] <- "Genus unassigned"
ps_network_coords_only <- data.frame(ps_network_coords$X_Axis, ps_network_coords$Y_Axis)
fviz_nbclust(ps_network_coords_only, kmeans, method = "wss")
kmeans_ps_network_three <- kmeans(ps_network_coords_only, 3, nstart = 20)
kmeans_ps_network_three
kmeans_ps_network_four <- kmeans(ps_network_coords_only, 4, nstart = 20)
kmeans_ps_network_four
kmeans_ps_network_seven <- kmeans(ps_network_coords_only, 7, nstart = 20)
kmeans_ps_network_seven
ps_network_coords_cluster <- cbind(ps_network_coords, kmeans_ps_network_three$cluster)
head(ps_network_coords_cluster)
kmeans_plot_3 <- plot(ps_network_coords_only, col = (kmeans_ps_network_three$cluster + 1), main = "K-Means Clustering of Bacterial Genuses in May 2022 Samples, k = 3", xlab = "", ylab = "", pch = 20, cex = 0.5)
cluster1_genuses <- ps_network_coords_cluster[ps_network_coords_cluster$`kmeans_ps_network_three$cluster` == 1, ]
cluster2_genuses <- ps_network_coords_cluster[ps_network_coords_cluster$`kmeans_ps_network_three$cluster` == 2, ]
cluster3_genuses <- ps_network_coords_cluster[ps_network_coords_cluster$`kmeans_ps_network_three$cluster` == 3, ]


#Wilcox Test
#I have separated out Clusters 1 and 3 into a single dataframe and Cluster 2 into a separate dataframe
#Cluster 2 has the metastatic samples
cluster13_abundance <- read.csv("seqtab_relative_Cluster1_Cluster3.csv", header = TRUE, row.names = 1)
cluster2_abundance <- read.csv("seqtab_relative_Cluster2.csv", header = TRUE, row.names = 1)
cluster13_matrix <- as.matrix(cluster13_abundance)
cluster2_matrix <- as.matrix(cluster2_abundance)
wilcox_result <- wilcox.test(cluster13_matrix, cluster2_matrix)
#Create a Phyloseq Object to Compare the following
#Create One with Only Cluster 3 and compare metastatic to non-metastatic samples within the cluster
#Create One for Clusters 1 and 2 separately and compare them.
#Creare one for clusters 1 and 2 together and compare them.
